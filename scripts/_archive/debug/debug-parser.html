<!DOCTYPE html>
<html>
<head>
  <title>FanDuel Parser Debugger</title>
  <style>
    body {
      font-family: monospace;
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
    }
    textarea {
      width: 100%;
      height: 300px;
      font-size: 12px;
      padding: 10px;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      margin: 10px 5px;
      cursor: pointer;
    }
    #output {
      margin-top: 20px;
      padding: 15px;
      background: #f5f5f5;
      border-radius: 4px;
      white-space: pre-wrap;
      font-size: 12px;
    }
    .error { color: red; }
    .success { color: green; }
  </style>
</head>
<body>
  <h1>FanDuel Parser Debug Tool</h1>
  <p>Paste your FanDuel HTML here and click "Parse" to see what's happening:</p>
  <textarea id="htmlInput" placeholder="Paste FanDuel HTML here..."></textarea>
  <br>
  <button onclick="parseHTML()">Parse</button>
  <button onclick="analyzeStructure()">Analyze Structure</button>
  <button onclick="clearOutput()">Clear</button>
  <div id="output"></div>

  <script type="module">
    // Import the parser (we'll need to adapt this for browser)
    // For now, let's inline a simplified version for debugging
    
    function normalizeText(text) {
      if (!text) return "";
      return text.replace(/\s+/g, " ").trim();
    }

    function parseAmount(text) {
      if (!text) return 0;
      const cleaned = text.replace(/[$,]/g, "");
      const parsed = parseFloat(cleaned);
      return isNaN(parsed) ? 0 : parsed;
    }

    function parseAmericanOdds(text) {
      if (!text) return 0;
      const cleaned = text.replace(/[+\s]/g, "");
      const parsed = parseFloat(cleaned);
      return isNaN(parsed) ? 0 : parsed;
    }

    function findBetIdElements(doc) {
      const elements = [];
      const walker = doc.createTreeWalker(
        doc.body || doc.documentElement,
        NodeFilter.SHOW_TEXT,
        null
      );

      let node;
      while ((node = walker.nextNode())) {
        if (node.textContent?.includes('BET ID:')) {
          const parent = node.parentElement;
          if (parent) {
            elements.push(parent);
          }
        }
      }
      return elements;
    }

    function findBetCard(betIdElement) {
      let current = betIdElement;
      while (current) {
        const text = current.textContent || '';
        const hasBetId = text.includes('BET ID:');
        const hasWager = text.includes('TOTAL WAGER');
        const hasReturned = text.includes('RETURNED');
        const hasPlaced = text.includes('PLACED:');
        const hasOdds = current.querySelector('span[aria-label^="Odds"]') !== null;
        const hasSGP = text.includes('Same Game Parlay');
        
        if (hasBetId && hasWager && hasReturned && hasPlaced && (hasOdds || hasSGP)) {
          return current;
        }
        current = current.parentElement;
      }
      return null;
    }

    window.parseHTML = function() {
      const html = document.getElementById('htmlInput').value;
      const output = document.getElementById('output');
      
      if (!html.trim()) {
        output.innerHTML = '<span class="error">No HTML provided</span>';
        return;
      }

      try {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
        const betIdElements = findBetIdElements(doc);
        output.innerHTML = `<div class="success">Found ${betIdElements.length} BET ID elements</div>\n\n`;
        
        let foundCards = 0;
        betIdElements.forEach((el, idx) => {
          const betIdMatch = el.textContent?.match(/BET ID:\s*([^\s]+)/);
          if (betIdMatch) {
            const betId = betIdMatch[1];
            const card = findBetCard(el);
            if (card) {
              foundCards++;
              output.innerHTML += `\n=== Bet ${foundCards} (ID: ${betId}) ===\n`;
              
              // Extract odds
              const oddsSpan = card.querySelector('span[aria-label^="Odds"]');
              if (oddsSpan) {
                const oddsText = oddsSpan.getAttribute('aria-label') || oddsSpan.textContent;
                output.innerHTML += `Odds: ${oddsText}\n`;
              }
              
              // Extract stake
              const wagerLabel = Array.from(card.querySelectorAll('span')).find(
                span => normalizeText(span.textContent) === 'TOTAL WAGER'
              );
              if (wagerLabel) {
                const parent = wagerLabel.parentElement;
                if (parent) {
                  const dollarSpans = Array.from(parent.querySelectorAll('span')).filter(
                    span => span.textContent?.trim().startsWith('$')
                  );
                  if (dollarSpans.length > 0) {
                    output.innerHTML += `Stake: ${dollarSpans[0].textContent}\n`;
                  }
                }
              }
              
              // Extract legs
              const svgs = Array.from(card.querySelectorAll('svg'));
              let legCount = 0;
              svgs.forEach(svg => {
                const svgId = svg.getAttribute('id') || '';
                const fill = svg.getAttribute('fill') || '';
                const isTick = svgId.includes('tick-circle') || fill === '#128000';
                const isCross = svgId.includes('cross_circle') || fill === '#D22839';
                if (isTick || isCross) {
                  legCount++;
                }
              });
              output.innerHTML += `Legs found: ${legCount}\n`;
              
              output.innerHTML += `\n`;
            } else {
              output.innerHTML += `\n<span class="error">Could not find bet card for BET ID: ${betId}</span>\n\n`;
            }
          }
        });
        
        output.innerHTML += `\n\n<span class="${foundCards > 0 ? 'success' : 'error'}">Total bet cards found: ${foundCards}</span>`;
        
      } catch (error) {
        output.innerHTML = `<span class="error">Error: ${error.message}\n${error.stack}</span>`;
      }
    };

    window.analyzeStructure = function() {
      const html = document.getElementById('htmlInput').value;
      const output = document.getElementById('output');
      
      if (!html.trim()) {
        output.innerHTML = '<span class="error">No HTML provided</span>';
        return;
      }

      try {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
        output.innerHTML = '=== HTML Structure Analysis ===\n\n';
        
        // Find all BET ID occurrences
        const betIdMatches = html.match(/BET ID:\s*([^\s<]+)/g);
        output.innerHTML += `BET ID patterns found: ${betIdMatches ? betIdMatches.length : 0}\n`;
        if (betIdMatches) {
          betIdMatches.forEach((match, idx) => {
            output.innerHTML += `  ${idx + 1}. ${match}\n`;
          });
        }
        
        // Find odds spans
        const oddsSpans = doc.querySelectorAll('span[aria-label^="Odds"]');
        output.innerHTML += `\nOdds spans found: ${oddsSpans.length}\n`;
        oddsSpans.forEach((span, idx) => {
          output.innerHTML += `  ${idx + 1}. ${span.getAttribute('aria-label')} | Text: ${span.textContent}\n`;
        });
        
        // Find SGP labels
        const sgpLabels = Array.from(doc.querySelectorAll('span')).filter(
          span => span.textContent?.includes('Same Game Parlay')
        );
        output.innerHTML += `\nSGP labels found: ${sgpLabels.length}\n`;
        
        // Find TOTAL WAGER labels
        const wagerLabels = Array.from(doc.querySelectorAll('span')).filter(
          span => normalizeText(span.textContent) === 'TOTAL WAGER'
        );
        output.innerHTML += `\nTOTAL WAGER labels found: ${wagerLabels.length}\n`;
        
        // Find RETURNED labels
        const returnedLabels = Array.from(doc.querySelectorAll('span')).filter(
          span => normalizeText(span.textContent) === 'RETURNED'
        );
        output.innerHTML += `RETURNED labels found: ${returnedLabels.length}\n`;
        
        // Find result SVGs
        const resultSvgs = Array.from(doc.querySelectorAll('svg')).filter(svg => {
          const id = svg.getAttribute('id') || '';
          const fill = svg.getAttribute('fill') || '';
          return id.includes('tick-circle') || id.includes('cross_circle') || 
                 fill === '#128000' || fill === '#D22839';
        });
        output.innerHTML += `\nResult SVG icons found: ${resultSvgs.length}\n`;
        
      } catch (error) {
        output.innerHTML = `<span class="error">Error: ${error.message}</span>`;
      }
    };

    window.clearOutput = function() {
      document.getElementById('output').innerHTML = '';
    };
  </script>
</body>
</html>

